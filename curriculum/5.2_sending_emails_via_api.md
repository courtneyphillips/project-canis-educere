# Adding SendGrid to Cloud Functions

---

Now that we're safely managing our SendGrid API key in Google Secrets, we're ready to begin communicating with the SendGrid API.

We'll prepare our Cloud Function to use the SendGrid API. We can add the SendGrid npm package to our cloud function by navigating to our provided `package.json` file in the left sidebar of our Google Cloud Function.

Here, we can add a `"dependencies"` section to the existing JSON, and add `"@sendgrid/mail"` version `7.7.0`, like this:

**package.json** in Google Cloud Console
```json
{
  "name": "sample-http",
  "version": "0.0.1",
  "dependencies": {
    "@sendgrid/mail": "^7.7.0"
  }
}
```

Each time we deploy new code to our Google Cloud Functions, GCP automatically runs `$ npm install` as part of the build/deployment process. Which means we can add new packages directly to _package.json_, without any additional commands.

With this package now installed into our project, we can now import the SendGrid library's functionalities into the file containing our cloud function.

In the `index.js` file within the Google Cloud Console, we'll add the following `require` statement at the top of the file:

```javascript
const https = require('https');
const SENDGRID_API_KEY = process.env.SENDGRID_API_KEY;
const sgMail = require('@sendgrid/mail');

[...]

```

Next, we'll begin writing a function that uses this API key to send an email. For now, we'll hard code the email details until we confirm it works:

```javascript

const https = require('https');
const SENDGRID_API_KEY = process.env.SENDGRID_API_KEY;
const sgMail = require('@sendgrid/mail');

function compileAndSendEmailReport(orgData, learnerData, callback = () => {}){
  sgMail.setApiKey(SENDGRID_API_KEY);
  const emailObject = {
    to: 'courtney.mae.phillips+recipient@gmail.com',
    from: 'courtney.mae.phillips@gmail.com',
    subject: 'Your LMS Learner Report',
    text: "HELLO FROM THE CLOUD!"
  }
  sgMail.send(emailObject).then(() => {
      console.log('Email sent');
      callback('email sent')
    })
    .catch((error) => {
      console.error(error)
      console.error("error sending")
      callback([])
    })
}

[...]
```

//NOTE ABOUT MUST USE YOUR Email

//NOTE ABOUT + NOTATION

Then, we'll call our new method in `serveLmsReport()`:

```JavaScript

const https = require('https');
const SENDGRID_API_KEY = process.env.SENDGRID_API_KEY;
const sgMail = require('@sendgrid/mail');

function compileAndSendEmailReport(orgData, learnerData, callback = () => {}){
  sgMail.setApiKey(SENDGRID_API_KEY);
  const emailObject = {
    to: 'courtney.mae.phillips+recipient@gmail.com',
    from: 'courtney.mae.phillips@gmail.com',
    subject: 'Your LMS Learner Report',
    text: "HELLO FROM THE CLOUD!"
  }
  sgMail.send(emailObject).then(() => {
      console.log('Email sent');
      callback('email sent')
    })
    .catch((error) => {
      console.error(error)
      console.error("error sending")
      callback([])
    })
}

function retrieveLearnerDataByOrg(parsedOrgData, callback = () => {}) {
  let url = 'https://mockend.com/courtneyphillips/canis-educere-mock-api/learner?orgId_eq=' + encodeURIComponent(parsedOrgData[0].id);
  https.get(url, (response) => {
    let data = '';
    response.on('data', (chunk) => {
      data += chunk;
    });
    response.on('end', () => {
      console.log("parsedData");
      const parsedLearnerData = JSON.parse(data);
      callback(parsedLearnerData);
    });
  }).on('error', (err) => {
    console.error(err);
    callback([]);
  });
}

exports.serveLmsReports = (req, res) => {
  let url = 'https://mockend.com/courtneyphillips/canis-educere-mock-api/organization?companyName_eq=' + encodeURIComponent(req.body.orgName);
  https.get(url, (response) => {
    let data = '';
    response.on('data', (chunk) => {
      data += chunk;
    });
    response.on('end', () => {
      const parsedOrgData = JSON.parse(data);
      retrieveLearnerDataByOrg(parsedOrgData, (parsedLearnerData) => {
        console.log(parsedLearnerData);
        let emailConfirmation = compileAndSendEmailReport(parsedOrgData, parsedLearnerData);
        console.log(emailConfirmation);
        res.status(200).send("Request successfully processed by the contactLMS function in GCP!")
      });
    });
  }).on('error', (err) => {
    console.error(err);
    res.status(500).send('Oh no, there was an error in processing your request. Check Logs for GCP and Apps Scripts.');
  });
};
```

As always, make sure to `Deploy` the updated code to ensure your changes are relected in the cloud.

You should now be able to submit another sample form, adn this time, reeive an email in your inbox!

![email from api](../assets/images/email_received_from_api.png)

| ⚠️  Important Note |
|--------------------|
| Authorization header error? Likely an unseen whitespace or character in your SendGrid API key. To troubleshoot, try trimming out any whitespace with RegEx...or generating a new key. |


Next, we can format an display the actual learner data:

```
const https = require('https');
const SENDGRID_API_KEY = process.env.SENDGRID_API_KEY;
const sgMail = require('@sendgrid/mail');

function compileAndSendEmailReport(orgData, learnerData, callback = () => {}){
  sgMail.setApiKey(SENDGRID_API_KEY);

  let report = "";

  learnerData.forEach((learner) => {
    report += `Name: ${learner.name}\n`;
    report += `Email: ${learner.email}\n`;
    report += `Role: ${learner.roleType}\n`;
    report += `Organization ID: ${learner.organizationId}\n`;
    report += `Account Creation Date: ${learner.accountCreation}\n`;
    report += `Active Learning Hours: ${learner.activeLearningHours}\n`;
    report += `Fundamentals Certified: ${learner.fundamentalsCertified}\n`;
    report += `Advanced Skills Certified: ${learner.advancedSkillsCertified}\n`;
    report += `DevOps Certified: ${learner.devOpsCertified}\n`;
    report += `Kubernetes Certified: ${learner.kubernetesCertified}\n\n`;
  });

  const emailObject = {
    to: 'courtney.mae.phillips+recipient@gmail.com',
    from: 'courtney.mae.phillips@gmail.com',
    subject: 'Your LMS Learner Report',
    text: report
  }
  sgMail.send(emailObject).then(() => {
      console.log('Email sent');
      callback('email sent')
    })
    .catch((error) => {
      console.error(error)
      console.error("error sending")
      callback([])
    })
}


function retrieveLearnerDataByOrg(parsedOrgData, callback = () => {}) {
  let url = 'https://mockend.com/courtneyphillips/canis-educere-mock-api/learner?orgId_eq=' + encodeURIComponent(parsedOrgData[0].id);
  https.get(url, (response) => {
    let data = '';
    response.on('data', (chunk) => {
      data += chunk;
    });
    response.on('end', () => {
      console.log("parsedData");
      const parsedLearnerData = JSON.parse(data);
      callback(parsedLearnerData);
    });
  }).on('error', (err) => {
    console.error(err);
    callback([]);
  });
}

exports.serveLmsReports = (req, res) => {
  let url = 'https://mockend.com/courtneyphillips/canis-educere-mock-api/organization?companyName_eq=' + encodeURIComponent(req.body.orgName);
  https.get(url, (response) => {
    let data = '';
    response.on('data', (chunk) => {
      data += chunk;
    });
    response.on('end', () => {
      const parsedOrgData = JSON.parse(data);
      retrieveLearnerDataByOrg(parsedOrgData, (parsedLearnerData) => {
        console.log(parsedLearnerData);
        let emailConfirmation = compileAndSendEmailReport(parsedOrgData, parsedLearnerData);
        console.log(emailConfirmation);
        res.status(200).send("Request successfully processed by the contactLMS function in GCP!")
      });
    });
  }).on('error', (err) => {
    console.error(err);
    res.status(500).send('Oh no, there was an error in processing your request. Check Logs for GCP and Apps Scripts.');
  });
};
```

Finally, let's send this report to the actual requestor from the form, instaed of our own email address:

Our Apps Script should already be sending the `requestorEmail` from the form:

```JavaScript
const cloudFunctionsLocation = "https://us-central1-lms-automation-380021.cloudfunctions.net/lmsAutoReporting2";

function onNewFormSubmission(event) {
  let payloadToSendToGCP = {
    "method": "POST",
    "contentType": "application/json",
    "payload": JSON.stringify(
      {
        "requestorEmail": event.values[1],
        "orgName": event.values[2],
      }
    )
  }
  let response = UrlFetchApp.fetch(cloudFunctionsLocation, payloadToSendToGCP);
  let result = response.getContentText();
  console.log(result);
}
```

When this apps script triggers our cloud function, `serveLmsReports()` runs first, since we've specified it as our entry point. This function runs the other two helper functions.

When we call `compileAndSendEmailReport()` from `serveLmsReport()` we will simply pass in a third argument: the original requestor, accessed by req.body.requestorEmail:

```javascript
...

exports.serveLmsReports = (req, res) => {
  let url = 'https://mockend.com/courtneyphillips/canis-educere-mock-api/organization?companyName_eq=' + encodeURIComponent(req.body.orgName);
  https.get(url, (response) => {
    let data = '';
    response.on('data', (chunk) => {
      data += chunk;
    });
    response.on('end', () => {
      const parsedOrgData = JSON.parse(data);
      retrieveLearnerDataByOrg(parsedOrgData, (parsedLearnerData) => {
        console.log(parsedLearnerData);

        // line below is updated!
        let emailConfirmation = compileAndSendEmailReport(parsedOrgData, parsedLearnerData, req.body.requestorEmail);

        console.log(emailConfirmation);
        res.status(200).send("Request successfully processed by the contactLMS function in GCP!")
      });
    });
  }).on('error', (err) => {
    console.error(err);
    res.status(500).send('Oh no, there was an error in processing your request. Check Logs for GCP and Apps Scripts.');
  });
};

...

```


Then, we'll update our `compileAndSendEmailReport()` to accept this additional argument, and reference it in the payload sent to the SEndGrid API:

```JavaScript
function compileAndSendEmailReport(orgData, learnerData, requestorEmail, callback = () => {}){
  sgMail.setApiKey(SENDGRID_API_KEY);

  let report = "";

  learnerData.forEach((learner) => {
    report += `Name: ${learner.name}\n`;
    report += `Email: ${learner.email}\n`;
    report += `Role: ${learner.roleType}\n`;
    report += `Organization ID: ${learner.organizationId}\n`;
    report += `Account Creation Date: ${learner.accountCreation}\n`;
    report += `Active Learning Hours: ${learner.activeLearningHours}\n`;
    report += `Fundamentals Certified: ${learner.fundamentalsCertified}\n`;
    report += `Advanced Skills Certified: ${learner.advancedSkillsCertified}\n`;
    report += `DevOps Certified: ${learner.devOpsCertified}\n`;
    report += `Kubernetes Certified: ${learner.kubernetesCertified}\n\n`;
  });

  const emailObject = {
    to: requestorEmail,  // <-- New!
    from: 'courtney.mae.phillips@gmail.com',
    subject: 'Your LMS Learner Report',
    text: report
  }

  sgMail.send(emailObject).then(() => {
      console.log('Email sent');
      callback('email sent')
    })

    .catch((error) => {
      console.error(error)
      console.error("error sending")
      callback([])
    })
}
```

Redeploy. Resubmit a form (make sure to put ar equestor email that you have access to)

And it should still work.

---

| [⬅️  Back —]() | [— 🏠 Home —](https://github.com/courtneyphillips/project-canis-educere) | [— Next  ➡️]() |
| --- | --- | --- |
