# Triggering a Cloud Function via HTTP
---

We have three important pieces of our automated self-serve process in place:

1. A **form** for users to self-serve their LMS report requests
2. A **spreadsheet** that captures these requests, with a **trigger** to automatically executes logic when new form submissions are received.
3. A **cloud function** that will trigger upon receipt of an HTTP request.

Next, we need to weave these pieces into a singular, connected workflow. Specifically, we'll update our Apps Script to invoke our Cloud Function via HTTP. After confirming they can communicate, we'll pass form data to the cloud.

## Contacting a Cloud Function via HTTP

Let's revisit our Apps Script code. It looks like this:

**code.gs** in Google Apps Script
```JavaScript
function onNewFormSubmission(){
  console.log("hey, our function was invoked!")
}
```

// return to the editor

Let's update it to contact the cloud. We'll provide our Cloud Functions URL, and construct an HTTP request:

**code.gs** in Google Apps Script
```javascript
const cloudFunctionsLocation = "YOUR-UNIQUE-CLOUD-FUNCTIONS-URL-HERE";

function onNewFormSubmission() {
  let payloadToSendToGCP = {
    "method": "POST",
    "contentType": "application/json"
  }
}
```

_(If you didn't record this in the previous lesson, revisit your cloud function in the GCP dashboard. Hit _Edit_ and scroll down to the `Trigger URL` value)_

Then we'll send our HTTP request. Apps Script offers a built-in HTTP client called [**UrlFetchApp**](https://developers.google.com/apps-script/reference/url-fetch/url-fetch-app). We'll use its [`fetch()` method](https://developers.google.com/apps-script/reference/url-fetch/url-fetch-app#fetch(String,Object) to make a request, grab the response, and log it to the console:

**code.gs** in Google Apps Script
```javascript
const cloudFunctionsLocation = "YOUR-UNIQUE-CLOUD-FUNCTIONS-URL-HERE";

function onNewFormSubmission() {
  let payloadToSendToGCP = {
    "method": "POST",
    "contentType": "application/json"
  }
  let response = UrlFetchApp.fetch(cloudFunctionsLocation, payloadToSendToGCP);
  let result = response.getContentText();
  console.log(result);
}
```

Don't forget to save changes. This function will attempt to contact our GCP Cloud function at the URL provided via HTTP POST request.

Our cloud function currently sends a `Hello World!` back in response to any request:

**index.js** in Google Cloud Functions
```JavaScript
exports.helloWorld = (req, res) => {
  let message = req.query.message || req.body.message || 'Hello World!';
  res.status(200).send(message);
};
```

// mention this is an "OR" ternary situation

So, if the HTTP request sent by our Apps Script receives a `Hello World!`, we'll know it successfully made contact with the cloud.

Let's try it out! Revisit and resubmit sample data through your form. In another tab, revisit the App Scripts Executions log. Expanding the most recent entry should reveal a `Hello World!` from the cloud!

![Executions log entry with Hello World message from GCP](../assets/images/successful_http_req_to_gcp.png)

<details><summary>‚õî **Did you receive a log error?**: Click here for guidance </summary>
<br>
<p>
If you received an Apps Script log error reading `Exception: You do not have permission to call UrlFetchApp.fetch.`, it is because Apps Script does not have authorization to make HTTP requests from your account.
</p>
<p>
To grant permissions, return to the Apps Script editor. Click **_Run_** (‚ñ∂Ô∏è). You'll see an _Authorization required_ pop-up. Click _Review permissions_. You may receive another pop-up warning _Google hasn't verified this app_. At the bottom of this window is a tiny link reading _Advanced_. Click this. A menu will expand, reading _"Continue only if you understand the risks and trust the developer (YOUR-GOOGLE-ACCOUNT@gmail.com)."_
</p>
<p>
Now, this warning may feel alarming. But notice that the developer you are entrusting is _**yourself**_. You are granting yourself the ability to run `UrlFetchApp` on your own account. Click the small link reading _Go to Untitled project (unsafe)_. Click _Allow_ in the next screen.
</p>
<p>
At the conclusion of this module, we'll give you a reminder to optionally revoke these permissions (along with disabling API keys and other sensitive information created for this course).
</p>
<p>
After allowing these permissions, revisit and repeat the instructions in the paragraph above this panel.
</details>

---

| [‚¨ÖÔ∏è  Back ‚Äî]() | [‚Äî üè† Home ‚Äî](https://github.com/courtneyphillips/project-canis-educere) | [‚Äî Next  ‚û°Ô∏è]() |
| --- | --- | --- |
